project:
    name: OutboundFunds
    source_format: sfdx
    package:
        name: Outbound Funds (Core)
        namespace: outfunds
        api_version: "48.0"
    git:
        repo_url: https://github.com/SalesforceFoundation/OutboundFunds

sources:
    bridge:
        github: https://github.com/SalesforceFoundation/OutboundFundsNPSP
    npsp:
        github: https://github.com/SalesforceFoundation/NPSP
    site_template:
        github: https://github.com/SalesforceFoundation/OutboundFundsCommunity

tasks:
    # Automerge Major Release Branches
    github_automerge_feature:
        options:
            update_future_releases: True

    delete_data:
        options:
            objects:
                - Requirement__c
                - Disbursement__c
                - Funding_Request__c
                - Funding_Program__c
                - Contact
                - Account

    install_sfdo_base:
        class_path: cumulusci.tasks.salesforce.InstallPackageVersion
        options:
            name: "SFDO Base"
            namespace: sfdobase
            version: 1.0

    robot:
        options:
            suites: robot/OutboundFunds/tests
            options:
                outputdir: robot/OutboundFunds/results

    robot_libdoc:
        options:
            path: robot/OutboundFunds/resources/OutboundFunds.py,robot/OutboundFunds/resources/OutboundFunds.robot,robot/OutboundFunds/resources/*PageObject.py
            output: robot/OutboundFunds/doc/Keywords.html

    update_admin_profile:
        options:
            package_xml: lib/admin.profile-meta.xml
            include_packaged_objects: true

    check_enable_networks_enabled:
        description: Preflight check to validate that Digital Experiences are enabled.
        group: "OFM: Preflight Checks"
        class_path: cumulusci.tasks.preflight.settings.CheckSettingsValue
        options:
            settings_type: CommunitiesSettings
            settings_field: IsNetworksEnabledEnabled
            value: true

    create_perms_testing_user:
        description: Creates a test user for testing permissions.
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: "force:user:create -a permtest --definitionfile robot/OutboundFunds/resources/qa_org/users/perms_test_user.json"

    deploy_qa_config:
        description: Deploys additional fields used for QA purposes only
        class_path: cumulusci.tasks.salesforce.Deploy
        group: Salesforce Metadata
        options:
            path: robot/OutboundFunds/resources/unpackaged/qa

flows:
    config_dev:
        steps:
            3:
                task: load_dataset

    config_qa:
        steps:
            3:
                task: load_dataset
            4:
                task: deploy_qa_config
            5:
                task: create_perms_testing_user

    dev_org_2gp:
        steps:
            1:
                flow: install_2gp_commit
            2:
                flow: config_dev
            3:
                task: snapshot_changes

    customer_org:
        steps:
            1:
                task: install_sfdo_base
            2:
                flow: install_prod_no_config
            3:
                task: bridge:install_managed
                ui_options:
                    is_required: False
                checks:
                    - when: "'npsp' not in tasks.get_installed_packages()"
                      action: hide
                when: "org_config.has_minimum_package_version('npsp', '1.0')"
            4:
                flow: install_ofm_template
                ui_options:
                    name: "Install the Outbound Funds Module Site Template"
                    is_required: False
                checks:
                    - when: "not tasks.check_enable_networks_enabled()"
                      action: hide

    install_npsp:
        steps:
            1:
                flow: npsp:install_prod
            2:
                task: bridge:install_managed

    install_ofm_template:
        steps:
            1:
                task: site_template:deploy_pre
            2:
                task: site_template:install_managed_beta
            3:
                task: site_template:deploy_post


orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            days: 7
            namespaced: True
        demo:
            config_file: orgs/demo.json
            days: 30
        prerelease:
            config_file: orgs/prerelease.json
        beta_prerelease:
            config_file: orgs/beta_prerelease.json

plans:
    install:
        slug: install
        title: Install Outbound Funds Module
        tier: primary
        is_listed: True
        preflight_message: "This will install Outbound Funds Module into your org."
        post_install_message: "Thanks for installing Outbound Funds Module. Please visit the [Outbound Funds Module](https://powerofus.force.com/s/group/0F980000000CvlMCAS) community group on the Power of Us Hub for any questions about Outbound Funds Module."
        error_message: "To get help with this error, go to [help.salesforce.com](https://help.salesforce.com/), find the Support & Services area, and log a technical support ticket with Salesforce. Include “Outbound Funds Module” in the subject line and include in your comment the installation link shown here."
        checks:
            - when: "not tasks.check_chatter_enabled()"
              action: error
              message: "Outbound Funds Module requires Chatter. Please enable Chatter in your org and try again."
            - when: "'.my.' not in org_config.instance_url"
              action: error
              message: "Enable My Domain in your org prior to installing."
            - when: "not tasks.check_enable_networks_enabled()"
              action: warn
              message: "The Fundseeker Starter site template requires that Digital Experiences is enabled. Make sure to enable it in your org before installing the site template."
        steps:
            1:
                flow: customer_org
